@model List<WEBNEO.Entities.VentaDTO>
@{
    ViewData["Title"] = "Listado de Ventas";
}

<div class="page-header d-flex justify-content-between align-items-center mb-4">
    <div>
        <h3 class="fw-bold"><i class="fas fa-list-ul me-2 text-primary"></i>Listado de Ventas</h3>
        <p class="text-muted mb-0">Gestión de transacciones realizadas</p>
    </div>
    <a href="@Url.Action("Nueva", "Ventas")" class="btn btn-primary shadow-sm rounded-pill px-4">
        <i class="fas fa-plus me-1 text-warning"></i> Nueva Venta
    </a>
</div>

<div class="card shadow-sm border-0">
    <div class="card-body p-4">
        <div class="table-responsive">
            <table id="grvVentas" class="table table-hover table-striped align-middle border" style="width:100%">
                <thead class="bg-neonet-purple text-white">
                    <tr>
                        <th width="80">ID</th>
                        <th>Fecha</th>
                        <th>Cliente</th>
                        <th class="text-center">Estado</th>
                        <th>Registro</th>
                        <th width="50" class="text-center">Acción</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model)
                    {
                        <tr>
                            <td class="fw-bold text-primary">#@item.Id</td>
                            <td>@(item.Fecha?.ToString("dd/MM/yyyy") ?? "-")</td>
                            <td><i class="fas fa-user-circle me-1 text-muted"></i>@item.ClienteNombre</td>
                            <td class="text-center">
                                @if (item.Estado == 1)
                                {
                                    <span class="badge bg-success rounded-pill px-3">Activo</span>
                                }
                                else
                                {
                                    <span class="badge bg-danger rounded-pill px-3">Inactivo</span>
                                }
                            </td>
                            <td class="small text-muted">@(item.FechaRegistro?.ToString("dd/MM/yyyy HH:mm") ?? "-")</td>
                            <td class="text-center">
                                <button class="btn btn-sm btn-outline-primary btn-ver-detalle" data-id="@item.Id" title="Ver Detalle">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- MODAL DETALLE VENTA -->
<div class="modal fade" id="modalDetalle" tabindex="-1">
    <div class="modal-dialog modal-lg shadow">
        <div class="modal-content border-0">
            <div class="modal-header bg-neonet-purple text-white py-3">
                <h5 class="modal-title fw-bold"><i class="fas fa-receipt me-2"></i>Detalle de Venta #<span id="lblVentaId"></span></h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body p-4">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <p class="mb-1 small text-uppercase text-secondary fw-bold">Cliente</p>
                        <h6 id="lblClienteDetalle" class="fw-bold text-dark">-</h6>
                    </div>
                    <div class="col-md-6 text-md-end">
                        <p class="mb-1 small text-uppercase text-secondary fw-bold">Fecha</p>
                        <h6 id="lblFechaDetalle" class="fw-bold text-dark">-</h6>
                    </div>
                </div>
                
                <div class="table-responsive border rounded bg-light">
                    <table id="tbDetalleVenta" class="table table-sm table-hover mb-0 bg-white">
                        <thead class="bg-light">
                            <tr>
                                <th>Producto</th>
                                <th class="text-center">Cant.</th>
                                <th class="text-end">Precio</th>
                                <th class="text-end">Subtotal</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Dinámico -->
                        </tbody>
                        <tfoot class="bg-light border-top">
                            <tr>
                                <th colspan="3" class="text-end py-2">TOTAL</th>
                                <th class="text-end py-2 text-primary fs-5">Q. <span id="lblTotalVenta">0.00</span></th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
            <div class="modal-footer bg-light border-0">
                <button type="button" class="btn btn-secondary rounded-pill px-4" data-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            $('#grvVentas').DataTable({
                responsive: true,
                order: [[0, "desc"]],
                language: {
                    url: "//cdn.datatables.net/plug-ins/1.10.21/i18n/Spanish.json"
                }
            });

            $(document).on("click", ".btn-ver-detalle", function() {
                const id = $(this).data("id");
                $("#lblVentaId").text(id);
                $("#tbDetalleVenta tbody").empty();
                
                $.LoadingOverlay("show");

                $.get('@Url.Action("Detalle", "Ventas")/' + id, function(data) {
                    $.LoadingOverlay("hide");
                    let total = 0;
                    if(data && data.length > 0) {
                        $("#lblClienteDetalle").text(data[0].cliente);
                        $("#lblFechaDetalle").text(moment(data[0].fecha).format('DD/MM/YYYY HH:mm'));
                        
                        data.forEach(d => {
                            total += d.subtotal;
                            $("#tbDetalleVenta tbody").append(`
                                <tr>
                                    <td>${d.producto}</td>
                                    <td class="text-center">${d.cantidad}</td>
                                    <td class="text-end">Q. ${d.precioUnitario.toFixed(2)}</td>
                                    <td class="text-end fw-bold">Q. ${d.subtotal.toFixed(2)}</td>
                                </tr>
                            `);
                        });
                        $("#lblTotalVenta").text(total.toFixed(2));
                        $("#modalDetalle").modal("show");
                    } else {
                        Swal.fire("Aviso", "No se encontraron detalles para esta venta", "info");
                    }
                }).fail(function() {
                    $.LoadingOverlay("hide");
                    Swal.fire("Error", "Error al obtener detalles", "error");
                });
            });
        });
    </script>
}

<style>
    .bg-neonet-purple { background-color: #6B46C1 !important; }
    #tbDetalleVenta thead th { font-size: 0.75rem; text-transform: uppercase; color: #6c757d; border-top: none; }
</style>
