@{
    ViewData["Title"] = "Ventas por Cliente";
}

@section Scripts{
    <script src="https://unpkg.com/feather-icons"></script>
    <script>
        $(document).ready(function () {
            feather.replace();

            let clienteIdSeleccionado = 0;

            // --- CONFIGURACION DATATABLES ---
            
            // 1. Tabla de Busqueda de Clientes 
            const tabClientes = $("#grvClientes").DataTable({
                responsive: true,
                "ajax": {
                    "url": '@Url.Action("Listar", "Clientes")',
                    "type": "GET",
                    "datatype": "json"
                },
                "columns": [
                    { "data": "id" },
                    { "data": "nombre" },
                    { "data": "email" },
                    {
                        "defaultContent": '<button class="btn btn-primary btn-sm btn-seleccionar-cliente"><i class="fas fa-check"></i></button>',
                        "orderable": false,
                        "searchable": false,
                        "width": "30px"
                    }
                ],
                "language": {
                    "url": "//cdn.datatables.net/plug-ins/1.10.21/i18n/Spanish.json"
                }
            });

            // Tabla de Ventas 
                  const tabVentas = $('#grvVentas').DataTable({
            responsive: true,
            order: [[1, "desc"]], // Ordenar por Fecha desc
            language: {
                url: "//cdn.datatables.net/plug-ins/1.10.21/i18n/Spanish.json"
            },
            columnDefs: [
                { className: "text-center", targets: [0, 3, 4] }
            ]
        });


            // --- LOGICA BUSQUEDA CLIENTE ---

            $("#btnModalClientes").click(function () {
                $("#modalClientes").modal("show");
            });

            $(document).on("click", ".btn-seleccionar-cliente", function () {
                const data = tabClientes.row($(this).parents("tr")).data();
                seleccionarCliente(data);
                $("#modalClientes").modal("hide");
            });

            $("#btnBuscarClienteEmail").click(function() {
                buscarCliente();
            });

            $("#txtEmailCliente").on("keypress", function (e) {
                if (e.which == 13) buscarCliente();
            });

            function buscarCliente() {
                let email = $("#txtEmailCliente").val();
                if(email) {
                    $.LoadingOverlay("show");
                    fetch(`@Url.Action("Buscar", "Clientes")?email=${email}`)
                    .then(res => res.json())
                    .then(data => {
                        $.LoadingOverlay("hide");
                        if(data) seleccionarCliente(data);
                        else Swal.fire("No encontrado", "Cliente no registrado", "warning");
                    }).catch(err => {
                         $.LoadingOverlay("hide");
                         Swal.fire("Error", "Error al buscar cliente", "error");
                    });
                }
            }

            function seleccionarCliente(cliente) {
                $("#lblIdCliente").val(cliente.id);
                $("#txtEmailCliente").val(cliente.email);
                $("#txtNombreCliente").val(cliente.nombre);
                $("#txtEmailCliente").addClass("is-valid");
                
                clienteIdSeleccionado = cliente.id;
                cargarVentas(cliente.id);
            }

            // --- CARGAR VENTAS ---

            function cargarVentas(id) {
                $.LoadingOverlay("show");
                
                // Limpiar tabla actual
                tabVentas.clear().draw();

                $.get('@Url.Action("GetHistorialJson", "Ventas")?clienteId=' + id, function(data) {
                      console.log("Resultado del historial:", data); 

                    $.LoadingOverlay("hide");
                    if(data && data.length > 0) {
                        data.forEach(item => {
                            console.log("Procesando item:", item);
                            let estadoBadge = item.estado == 1 
                                ? '<span class="badge bg-success rounded-pill px-3">Activo</span>' 
                                : '<span class="badge bg-danger rounded-pill px-3">Inactivo</span>';
                            
                            let fecha = item.fecha ? moment(item.fecha).format("DD/MM/YYYY") : "-";
                            let fechaReg = item.fechaRegistro ? moment(item.fechaRegistro).format("DD/MM/YYYY HH:mm") : "-";

                            tabVentas.row.add([
                                `<span class="fw-bold text-primary">#${item.id}</span>`,
                                fecha,
                                `<i class="fas fa-user-circle me-1 text-muted"></i>${item.clienteNombre}`,
                                estadoBadge,
                                `<button class="btn btn-sm btn-outline-primary btn-ver-detalle" data-id="${item.id}" title="Ver Detalle"><i class="fas fa-eye"></i></button>`
                            ]).draw(false);
                        });
                        feather.replace();
                    } else {
                        Swal.fire("Sin registros", "Este cliente no tiene ventas registradas", "info");
                    }
                }).fail(function() {
                    $.LoadingOverlay("hide");
                    Swal.fire("Error", "No se pudo obtener el historial de ventas", "error");
                });
            }

            // --- DETALLE DE VENTA (Copiado de Index.cshtml) ---

             $(document).on("click", ".btn-ver-detalle", function() {
                const id = $(this).data("id");
                $("#lblVentaId").text(id);
                $("#tbDetalleVenta tbody").empty();
                $("#lblTotalVenta").text("0.00");
                
                $.LoadingOverlay("show");

                $.get('@Url.Action("Detalle", "Ventas")/' + id, function(data) {
                    $.LoadingOverlay("hide");
                    let total = 0;
                    if(data && data.length > 0) {
                        $("#lblClienteDetalle").text(data[0].cliente);
                        $("#lblFechaDetalle").text(moment(data[0].fecha).format('DD/MM/YYYY HH:mm'));
                        
                        data.forEach(d => {
                            total += d.subtotal;
                            $("#tbDetalleVenta tbody").append(`
                                <tr>
                                    <td>${d.producto}</td>
                                    <td class="text-center">${d.cantidad}</td>
                                    <td class="text-end">Q. ${d.precioUnitario.toFixed(2)}</td>
                                    <td class="text-end fw-bold">Q. ${d.subtotal.toFixed(2)}</td>
                                </tr>
                            `);
                        });
                        $("#lblTotalVenta").text(total.toFixed(2));
                        $("#modalDetalle").modal("show");
                    } else {
                        Swal.fire("Aviso", "No se encontraron detalles para esta venta", "info");
                    }
                }).fail(function() {
                    $.LoadingOverlay("hide");
                    Swal.fire("Error", "Error al obtener detalles", "error");
                });
            });

            // Fallback para cerrar modales si el data-dismiss falla
            $(".close").click(function() {
                $(this).closest(".modal").modal("hide");
            });

        });
    </script>
}

<div class="page-header mb-4">
    <div class="page-title">
        <h3 class="fw-bold"><i class="fas fa-users me-2 text-primary"></i>Ventas por Cliente</h3>
        <p class="text-muted">Consulta el historial de compras de un cliente específico</p>
    </div>
</div>

<!-- FILTRO DE CLIENTE -->
<div class="card shadow-sm border-0 mb-4">
    <div class="card-body p-4">
        <div class="row g-3 align-items-end">
            <div class="col-md-4">
                <label class="form-label small fw-bold text-uppercase text-secondary mb-2">Email Cliente</label>
                <div class="input-group shadow-xs">
                    <span class="input-group-text bg-light border-end-0"><i class="fas fa-envelope text-muted"></i></span>
                    <input id="txtEmailCliente" type="text" class="form-control border-start-0 ps-0" placeholder="cliente@ejemplo.com">
                    <button class="btn btn-primary px-3" type="button" id="btnBuscarClienteEmail">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
            </div>
            <div class="col-md-5">
                <label class="form-label small fw-bold text-uppercase text-secondary mb-2">Nombre Cliente</label>
                <div class="input-group shadow-xs">
                    <input id="txtNombreCliente" type="text" class="form-control bg-light fw-bold" placeholder="Nombre del cliente..." readonly>
                    <input type="hidden" id="lblIdCliente">
                    <button class="btn btn-primary px-4 fw-bold" type="button" id="btnModalClientes">
                        <i class="fas fa-user-plus me-1"></i> Consultar
                    </button>
                </div>
            </div>
    
        </div>
    </div>
</div>

<!-- TABLA DE RESULTADOS -->
<div class="card shadow-sm border-0">
    <div class="card-body p-4">
        <div class="table-responsive">
            <table id="grvVentas" class="table table-hover table-striped align-middle border" style="width:100%">
                <thead class="bg-neonet-purple text-white">
                    <tr>
                        <th width="80">ID</th>
                        <th>Fecha</th>
                        <th>Cliente</th>
                        <th class="text-center">Estado</th>
                        <!-- Column removed as requested -->
                        <th width="50" class="text-center">Acción</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Se llena via JS -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- MODAL CLIENTES (Mismo que en Nueva.cshtml) -->
<div class="modal fade" id="modalClientes" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content border-0">
            <div class="modal-header bg-neonet-purple text-white py-2">
                <h6 class="modal-title fw-bold"><i data-feather="users" class="me-2 icon-16"></i>Clientes</h6>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="table-responsive">
                    <table id="grvClientes" class="table table-sm table-hover table-bordered w-100">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nombre</th>
                                <th>Email</th>
                                <th></th>
                            </tr>
                        </thead>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- MODAL DETALLE VENTA (Mismo que en Index.cshtml) -->
<div class="modal fade" id="modalDetalle" tabindex="-1">
    <div class="modal-dialog modal-lg shadow">
        <div class="modal-content border-0">
            <div class="modal-header bg-neonet-purple text-white py-3">
                <h5 class="modal-title fw-bold"><i class="fas fa-receipt me-2"></i>Detalle de Venta #<span id="lblVentaId"></span></h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body p-4">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <p class="mb-1 small text-uppercase text-secondary fw-bold">Cliente</p>
                        <h6 id="lblClienteDetalle" class="fw-bold text-dark">-</h6>
                    </div>
                    <div class="col-md-6 text-md-end">
                        <p class="mb-1 small text-uppercase text-secondary fw-bold">Fecha</p>
                        <h6 id="lblFechaDetalle" class="fw-bold text-dark">-</h6>
                    </div>
                </div>
                
                <div class="table-responsive border rounded bg-light">
                    <table id="tbDetalleVenta" class="table table-sm table-hover mb-0 bg-white">
                        <thead class="bg-light">
                            <tr>
                                <th>Producto</th>
                                <th class="text-center">Cant.</th>
                                <th class="text-end">Precio</th>
                                <th class="text-end">Subtotal</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Dinámico -->
                        </tbody>
                        <tfoot class="bg-light border-top">
                            <tr>
                                <th colspan="3" class="text-end py-2">TOTAL</th>
                                <th class="text-end py-2 text-primary fs-5">Q. <span id="lblTotalVenta">0.00</span></th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
            <div class="modal-footer bg-light border-0">
                <button type="button" class="btn btn-secondary rounded-pill px-4" data-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<style>
    .bg-neonet-purple { background-color: #6B46C1 !important; }
    .icon-16 { width: 16px; height: 16px; }
</style>
