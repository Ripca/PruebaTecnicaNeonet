@model List<WEBNEO.Entities.Producto>
@{
    ViewData["Title"] = "Productos";
}

<div class="container-fluid">
    <div class="page-header d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0 text-gray-800"><i class="fas fa-boxes mr-2 text-primary"></i>Gestión de Productos</h1>
            <p class="text-muted">Administre el inventario y catálogo de productos.</p>
        </div>
        <button class="btn btn-primary shadow-sm rounded-pill px-4" id="btnNuevo">
            <i class="fas fa-plus-circle mr-1 text-warning"></i> Nuevo Producto
        </button>
    </div>

    <div class="card shadow-sm border-0">
        <div class="card-body p-4">
            <div class="table-responsive">
                <table class="table table-hover table-bordered" id="tbData" width="100%" cellspacing="0">
                    <thead class="bg-neonet-purple text-white">
                        <tr>
                            <th>ID</th>
                            <th>Nombre</th>
                            <th>Precio</th>
                            <th>Stock</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- MODAL PRODUCTO -->
<div class="modal fade" id="modalProducto" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="modalTitle">Nuevo Producto</h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="txtId" value="0">
                <div class="form-group">
                    <label>Nombre</label>
                    <input type="text" class="form-control" id="txtNombre">
                </div>
                <div class="form-row">
                    <div class="form-group col-md-6">
                        <label>Precio</label>
                        <input type="number" class="form-control" id="txtPrecio" step="0.01">
                    </div>
                    <div class="form-group col-md-6">
                        <label>Stock</label>
                        <input type="number" class="form-control" id="txtStock">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="btnGuardar">Guardar</button>
            </div>
        </div>
    </div>
</div>

@section Scripts{
    <script>
        let tablaData;

        $(document).ready(function() {
            tablaData = $('#tbData').DataTable({
                responsive: true,
                "ajax": {
                    "url": '@Url.Action("Listar", "Productos")',
                    "type": "GET",
                    "datatype": "json"
                },
                "columns": [
                    { "data": "id" },
                    { "data": "nombre" },
                    { 
                        "data": "precio",
                        "render": function(data) {
                            return "Q. " + parseFloat(data).toFixed(2);
                        }
                    },
                    { "data": "stock" },
                    { 
                        "data": "estado",
                        "render": function(data) {
                            if (data == 1) return '<span class="badge badge-success">Activo</span>';
                            else return '<span class="badge badge-danger">Bloqueado</span>';
                        }
                    },
                    {
                        "defaultContent": '<button class="btn btn-primary btn-sm btn-edit mr-1"><i class="fas fa-pencil-alt"></i></button>' +
                                         '<button class="btn btn-warning btn-sm btn-status"><i class="fas fa-lock"></i></button>',
                        "orderable": false,
                        "searchable": false,
                        "width": "90px"
                    }
                ],
                "language": {
                    "url": "//cdn.datatables.net/plug-ins/1.10.21/i18n/Spanish.json"
                }
            });

            // Feather icons initialization if used, but we use FontAwesome here for consistency with the prompt and previous work

            // Fallback para cerrar modales
            $(".close").click(function() {
                $(this).closest(".modal").modal("hide");
            });
        });

        $("#btnNuevo").click(function() {
            $("#txtId").val(0);
            $("#txtNombre").val("");
            $("#txtPrecio").val("");
            $("#txtStock").val("");
            $("#modalTitle").text("Nuevo Producto");
            $("#modalProducto").modal("show");
        });

        $('#tbData tbody').on('click', '.btn-edit', function() {
            let data = tablaData.row($(this).parents('tr')).data();
            $("#txtId").val(data.id);
            $("#txtNombre").val(data.nombre);
            $("#txtPrecio").val(data.precio);
            $("#txtStock").val(data.stock);
            $("#modalTitle").text("Editar Producto");
            $("#modalProducto").modal("show");
        });

        $("#btnGuardar").click(function() {
            let id = parseInt($("#txtId").val());
            let request = {
                id: id,
                nombre: $("#txtNombre").val(),
                precio: parseFloat($("#txtPrecio").val()),
                stock: parseInt($("#txtStock").val())
            };

            let url = id === 0 ? '@Url.Action("Registrar", "Productos")' : '@Url.Action("Editar", "Productos")';
            let method = id === 0 ? 'POST' : 'PUT';

            fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(request)
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    Swal.fire("Éxito", data.message, "success");
                    $("#modalProducto").modal("hide");
                    tablaData.ajax.reload();
                } else {
                    Swal.fire("Error", data.message, "error");
                }
            });
        });

        $('#tbData tbody').on('click', '.btn-status', function() {
            let data = tablaData.row($(this).parents('tr')).data();
            let nuevoEstado = data.estado == 1 ? 0 : 1;
            let msg = data.estado == 1 ? "¿Bloquear producto?" : "¿Activar producto?";

            Swal.fire({
                title: msg,
                icon: "warning",
                showCancelButton: true,
                confirmButtonColor: "#3085d6",
                cancelButtonColor: "#d33",
                confirmButtonText: "Sí, cambiar"
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch(`@Url.Action("CambiarEstado", "Productos")?id=${data.id}&estado=${nuevoEstado}`, {
                        method: 'PATCH'
                    })
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            Swal.fire("Listo", data.message, "success");
                            tablaData.ajax.reload();
                        } else {
                            Swal.fire("Error", data.message, "error");
                        }
                    });
                }
            });
        });
    </script>
}

<style>
    .bg-neonet-purple { background-color: #6B46C1 !important; }
</style>
